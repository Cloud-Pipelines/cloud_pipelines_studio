"use strict";(self.webpackChunktangle_website=self.webpackChunktangle_website||[]).push([[6898],{7535:(e,s,t)=>{t.r(s),t.d(s,{assets:()=>a,contentTitle:()=>r,default:()=>u,frontMatter:()=>i,metadata:()=>o,toc:()=>l});const o=JSON.parse('{"id":"getting-started/custom-service-accounts","title":"Custom Service Accounts","description":"Oasis is designed for collaboration and chared use across teams.","source":"@site/docs/getting-started/custom-service-accounts.md","sourceDirName":"getting-started","slug":"/getting-started/custom-service-accounts","permalink":"/docs/getting-started/custom-service-accounts","draft":false,"unlisted":false,"tags":[],"version":"current","frontMatter":{"id":"custom-service-accounts","title":"Custom Service Accounts"},"sidebar":"docs","previous":{"title":"Adding Components to Pipelines","permalink":"/docs/component-development/adding-components"},"next":{"title":"What are Components?","permalink":"/docs/core-concepts/what-are-components"}}');var n=t(4848),c=t(8453);const i={id:"custom-service-accounts",title:"Custom Service Accounts"},r="Custom Service Accounts",a={},l=[{value:"Instructions",id:"instructions",level:2},{value:"Per-team - Set up team&#39;s custom Service Account",id:"per-team---set-up-teams-custom-service-account",level:3},{value:"Per-user - Allow a user to use the team&#39;s custom Service Account",id:"per-user---allow-a-user-to-use-the-teams-custom-service-account",level:3},{value:"Per-task - Use custom service account in a pipeline.",id:"per-task---use-custom-service-account-in-a-pipeline",level:3},{value:"Design and implementation details.",id:"design-and-implementation-details",level:2},{value:"Implementation:",id:"implementation",level:3}];function d(e){const s={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",ul:"ul",...(0,c.R)(),...e.components};return(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)(s.header,{children:(0,n.jsx)(s.h1,{id:"custom-service-accounts",children:"Custom Service Accounts"})}),"\n",(0,n.jsxs)(s.p,{children:["Oasis is designed for collaboration and chared use across teams.\nAll workloads (pipeline task executions) normally use same service account (",(0,n.jsx)(s.code,{children:"oasis-service-account@shopify-skypilot-clusters.iam.gserviceaccount.com"}),").\nHowever, some teams wish to use custom service account to that restricted data securely. This guide demonstrates how to set this up."]}),"\n",(0,n.jsx)(s.p,{children:"Important: Even when a task is executed under a custom service account, the output artifacts produced by that task are still placed in the same artifact store shared with all other Oasis users."}),"\n",(0,n.jsx)(s.h2,{id:"instructions",children:"Instructions"}),"\n",(0,n.jsxs)(s.p,{children:["In Shopify all cloud resource manipulations should be performed using Terraform via the ",(0,n.jsx)(s.a,{href:"https://github.com/Shopify/terraform-the-cloud/",children:"https://github.com/Shopify/terraform-the-cloud/"})," repository.\nThe repository is self-serve (your PRs can be approved by your team), but supported by the Shopify infra teams."]}),"\n",(0,n.jsx)(s.h3,{id:"per-team---set-up-teams-custom-service-account",children:"Per-team - Set up team's custom Service Account"}),"\n",(0,n.jsxs)(s.ol,{children:["\n",(0,n.jsxs)(s.li,{children:["\n",(0,n.jsxs)(s.p,{children:["Create a Google Cloud Service Account in some project. Example: ",(0,n.jsx)(s.code,{children:"sdp-stg-oasis-runner@sdp-stg-discovery-experience.iam.gserviceaccount.com"}),". ",(0,n.jsx)(s.a,{href:"https://github.com/Shopify/terraform-the-cloud/blob/43d09a086cda6c4df1ff15a0137efe124c3b9778/terraform/gcp/projects/sdp-stg-discovery-experience/project/iam.tf#L179-L184",children:"Example"}),"\nExample:"]}),"\n",(0,n.jsx)(s.pre,{children:(0,n.jsx)(s.code,{children:'resource "google_service_account" "sdp_stg_oasis_runner" {\n  project      = module.data_domain_project.project_id\n  account_id   = "sdp-stg-oasis-runner"\n  display_name = "Oasis runner for Discovery Experience Staging"\n  description  = "Shared service account for accessing cloud resources for Discovery Experience Staging"\n}\n'})}),"\n"]}),"\n",(0,n.jsxs)(s.li,{children:["\n",(0,n.jsxs)(s.p,{children:["Give that GSA any other desired permissions. Example: ",(0,n.jsx)(s.a,{href:"https://github.com/Shopify/terraform-the-cloud/pull/43297",children:"PR"})," ",(0,n.jsx)(s.a,{href:"https://github.com/Shopify/terraform-the-cloud/blob/43d09a086cda6c4df1ff15a0137efe124c3b9778/terraform/gcp/projects/sdp-stg-discovery-experience/project/iam.tf#L203",children:"Section"}),"\nExample:"]}),"\n",(0,n.jsx)(s.pre,{children:(0,n.jsx)(s.code,{children:'resource "google_project_iam_member" "sdp_stg_oasis_runner_iam" {\n  project = module.data_domain_project.project_id\n  for_each = toset([\n    "roles/bigquery.dataEditor",\n    "roles/bigquery.jobUser",\n    "roles/bigquery.readSessionUser",\n    "roles/iam.serviceAccountUser",\n    "roles/logging.logWriter",\n    "roles/pubsub.publisher",\n    "roles/run.invoker",\n    "roles/run.viewer",\n    "roles/secretmanager.secretAccessor"\n  ])\n  role   = each.key\n  member = google_service_account.sdp_stg_oasis_runner.member\n}\n'})}),"\n"]}),"\n",(0,n.jsxs)(s.li,{children:["\n",(0,n.jsxs)(s.p,{children:["Set up ",(0,n.jsx)(s.code,{children:"google_service_account_iam_binding"})," for the account, giving specific users permissions to use the team's GSA. See details in the next section: \"Per-user - Allow a user to use the team's custom Service Account\". ",(0,n.jsx)(s.a,{href:"https://github.com/Shopify/terraform-the-cloud/blob/9b166dbe904ee89a53f83c4d03c30fdb21a3d103/terraform/gcp/projects/sdp-stg-discovery-experience/project/iam.tf#L315",children:"link"}),"\nExample:"]}),"\n",(0,n.jsx)(s.pre,{children:(0,n.jsx)(s.code,{children:'# Grant Workload Identity permissions to individual users\' Kubernetes Service Accounts\n# This allows those users to impersonate the sdp-stg-oasis-runner SA in their Oasis pipeline runs.\nresource "google_service_account_iam_binding" "grant_oasis_sa_with_user_list" {\n  service_account_id = google_service_account.sdp_stg_oasis_runner.name\n  role               = "roles/iam.workloadIdentityUser"\n\n  members = [\n    # For use with the new Oasis SA annotation: `cloud-pipelines.net/launchers/google/service_account: sdp-stg-oasis-runner@sdp-stg-discovery-experience.iam.gserviceaccount.com`\n    # "principal://iam.googleapis.com/projects/430902663979/locations/global/workloadIdentityPools/shopify-skypilot-clusters.svc.id.goog/subject/ns/<team-service-account-at-team-project>/sa/<user-account-at-shopify-com>"\n  ]\n}\n'})}),"\n"]}),"\n",(0,n.jsxs)(s.li,{children:["\n",(0,n.jsxs)(s.p,{children:["Give that GSA write access to Oasis' GCS bucket (",(0,n.jsx)(s.a,{href:"https://github.com/Shopify/terraform-the-cloud/blob/43d09a086cda6c4df1ff15a0137efe124c3b9778/terraform/gcp/projects/sdp-prd-discovery-experience/project/gcs.tf#L69",children:"prd-oasis-tmp"}),"). See this ",(0,n.jsx)(s.a,{href:"https://github.com/Shopify/terraform-the-cloud/blob/43d09a086cda6c4df1ff15a0137efe124c3b9778/terraform/gcp/projects/sdp-prd-discovery-experience/project/gcs.tf#L119",children:"section"})]}),"\n",(0,n.jsx)(s.p,{children:"Only this part requires a review from the Oasis team."}),"\n",(0,n.jsx)(s.pre,{children:(0,n.jsx)(s.code,{children:'resource "google_storage_bucket_iam_member" "oasis_intermediate_data_access_for_custom_service_accounts" {\n    bucket   = google_storage_bucket.oasis_intermediate_data.name\n    member   = each.key\n    role     = "organizations/430199081660/roles/StorageUserOrg"  # Read/Write access\n    for_each = toset(\n      [\n          "serviceAccount:sdp-stg-oasis-runner@sdp-stg-discovery-experience.iam.gserviceaccount.com",\n      ]\n    )\n}\n'})}),"\n"]}),"\n"]}),"\n",(0,n.jsx)(s.h3,{id:"per-user---allow-a-user-to-use-the-teams-custom-service-account",children:"Per-user - Allow a user to use the team's custom Service Account"}),"\n",(0,n.jsx)(s.p,{children:"Now we need to allow some users to use the team's service account."}),"\n",(0,n.jsxs)(s.ol,{children:["\n",(0,n.jsxs)(s.li,{children:["Add a user-specific WorkloadIdentity principal to the team's GSA with the ",(0,n.jsx)(s.code,{children:"iam.workloadIdentityUser"})," role. Example ",(0,n.jsx)(s.a,{href:"https://github.com/Shopify/terraform-the-cloud/pull/48660/files",children:"PR"})]}),"\n"]}),"\n",(0,n.jsx)(s.p,{children:"Example:"}),"\n",(0,n.jsx)(s.pre,{children:(0,n.jsx)(s.code,{children:'# Grant Workload Identity permissions to individual users\' Kubernetes Service Accounts\n# This allows those users to impersonate the sdp-stg-oasis-runner SA in their Oasis pipeline runs.\nresource "google_service_account_iam_binding" "grant_oasis_sa_with_user_list" {\n  service_account_id = google_service_account.sdp_stg_oasis_runner.name\n  role               = "roles/iam.workloadIdentityUser"\n\n  members = [\n    # For use with the new Oasis SA annotation: `cloud-pipelines.net/launchers/google/service_account: sdp-stg-oasis-runner@sdp-stg-discovery-experience.iam.gserviceaccount.com`\n    "principal://iam.googleapis.com/projects/430902663979/locations/global/workloadIdentityPools/shopify-skypilot-clusters.svc.id.goog/subject/ns/sdp-stg-oasis-runner-at-sdp-stg-discovery-experience/sa/alexey-volkov-at-shopify-com",\n  ]\n}\n'})}),"\n",(0,n.jsxs)(s.p,{children:["The member principal format: ",(0,n.jsx)(s.code,{children:'"principal://iam.googleapis.com/projects/430902663979/locations/global/workloadIdentityPools/shopify-skypilot-clusters.svc.id.goog/subject/ns/<team-service-account-at-team-project>/sa/<user-account-at-shopify-com>"'})]}),"\n",(0,n.jsxs)(s.p,{children:["The last sections of this member string (",(0,n.jsx)(s.code,{children:"<team-service-account-at-team-project>"})," and ",(0,n.jsx)(s.code,{children:"<user-account-at-shopify-com>"}),') are Kubernetes resource names and must adhere to Kubernetes\' resource name syntax.\nSo, you\'ll need to convert the account name spelling in a specific way.\nLowercase all letters, replace "@" with "-at-", replace all other symbols (e.g. ".") with "-".\nAlso, the ".iam.gserviceaccount.com" SA suffix is removed.']}),"\n",(0,n.jsx)(s.p,{children:"The team's Google Service Account becomes a Kubernetes Namespace name:"}),"\n",(0,n.jsx)(s.pre,{children:(0,n.jsx)(s.code,{children:"From:   sdp-stg-oasis-runner@sdp-stg-discovery-experience.iam.gserviceaccount.com\nTo:     sdp-stg-oasis-runner-at-sdp-stg-discovery-experience\n"})}),"\n",(0,n.jsx)(s.p,{children:"The user's Google User Account becomes a Kubernetes ServiceAccount name:"}),"\n",(0,n.jsx)(s.pre,{children:(0,n.jsx)(s.code,{children:"From:   alexey.volkov@shopify.com\nTo:     alexey-volkov-at-shopify-com\n"})}),"\n",(0,n.jsx)(s.h3,{id:"per-task---use-custom-service-account-in-a-pipeline",children:"Per-task - Use custom service account in a pipeline."}),"\n",(0,n.jsx)(s.p,{children:"Custom service account should be set for each pipeline task that requires it."}),"\n",(0,n.jsxs)(s.ol,{children:["\n",(0,n.jsxs)(s.li,{children:['When editing a pipeline, select a pipeline Task node, navigate to the "Annotations" tab in the right side panel. Add a new annotation with name ',(0,n.jsx)(s.code,{children:"cloud-pipelines.net/launchers/google/service_account"})," and specify the team's service account as value (e.g. ",(0,n.jsx)(s.code,{children:"sdp-stg-oasis-runner@sdp-stg-discovery-experience.iam.gserviceaccount.com"}),"). In the future, there will be a dedicate UX input for this."]}),"\n"]}),"\n",(0,n.jsx)(s.p,{children:"Now, when the user submits the pipeline, the task annotated with teh custom SA will be executed under that SA."}),"\n",(0,n.jsx)(s.h2,{id:"design-and-implementation-details",children:"Design and implementation details."}),"\n",(0,n.jsx)(s.p,{children:"There are multiple design problems that need to be solved while designing a solution for custom service accounts."}),"\n",(0,n.jsxs)(s.ul,{children:["\n",(0,n.jsx)(s.li,{children:"How can the user specify the team SA that they want to use?"}),"\n",(0,n.jsx)(s.li,{children:"How can the system know whether the user can use the team's SA? Can this access be revoked?"}),"\n",(0,n.jsx)(s.li,{children:"What happens when some other user clones the pipeline that has some tasks annotated with team SA?"}),"\n"]}),"\n",(0,n.jsx)(s.h3,{id:"implementation",children:"Implementation:"}),"\n",(0,n.jsxs)(s.p,{children:["Oasis pipeline tasks are executed as Kubernetes Pods.\nKubernetes has concept of ServiceAccounts, but this is a lightweight abstraction that only exists inside the Kubernetes Cluster and is pretty disconnected from the world outside the cluster.\nHowever, Google Kubernetes Engine support a feature called ",(0,n.jsx)(s.a,{href:"https://cloud.google.com/kubernetes-engine/docs/how-to/workload-identity",children:"Workload Identity"})," which allows to bind a KSA (Kubernetes Service Account) to GSA (Google Service Account). This binding needs to be established on both sides - Kubernetes (via ",(0,n.jsx)(s.code,{children:"iam.gke.io/gcp-service-account"})," annotation on ServiceAccount) and Google Cloud IAM (via the ",(0,n.jsx)(s.code,{children:"roles/iam.workloadIdentityUser"})," permission)."]}),"\n",(0,n.jsx)(s.p,{children:"When launching a pipeline task for execution the Oasis backend does the following:"}),"\n",(0,n.jsxs)(s.p,{children:["By default, use the default ",(0,n.jsx)(s.code,{children:"oasis-service-account"})," KSA that's bound to ",(0,n.jsx)(s.code,{children:"oasis-service-account@shopify-skypilot-clusters.iam.gserviceaccount.com"})," GSA.\nHowever, if the ",(0,n.jsx)(s.code,{children:"cloud-pipelines.net/launchers/google/service_account"})," annotation is specified, then take the custom Google Service Account, the Google User Account and:"]}),"\n",(0,n.jsxs)(s.ol,{children:["\n",(0,n.jsxs)(s.li,{children:["If needed, create the Kubernetes Namespace corresponding to the team's Google Service Account: Example: ",(0,n.jsx)(s.code,{children:"sdp-stg-oasis-runner-at-sdp-stg-discovery-experience"})]}),"\n",(0,n.jsxs)(s.li,{children:["If needed, create the user Kubernetes ServiceAccount in the Kubernetes Namespace. Example: ",(0,n.jsx)(s.code,{children:"alexey-volkov-at-shopify-com"})]}),"\n",(0,n.jsxs)(s.li,{children:["Bind the user KSA to team GSA via the ",(0,n.jsx)(s.code,{children:"iam.gke.io/gcp-service-account"})," annotation."]}),"\n",(0,n.jsxs)(s.li,{children:["Create Kubernets Pod with ",(0,n.jsx)(s.code,{children:"namespace: sdp-stg-oasis-runner-at-sdp-stg-discovery-experience"})," and ",(0,n.jsx)(s.code,{children:"serviceAccountName: alexey-volkov-at-shopify-com"})]}),"\n"]}),"\n",(0,n.jsxs)(s.p,{children:["The implementation code ",(0,n.jsx)(s.a,{href:"https://github.com/Shopify/oasis-backend/blob/c0e9861c75eac4846f0a0096338c2a83a1c04942/launchers.py#L189-L211",children:"link"}),"."]})]})}function u(e={}){const{wrapper:s}={...(0,c.R)(),...e.components};return s?(0,n.jsx)(s,{...e,children:(0,n.jsx)(d,{...e})}):d(e)}}}]);